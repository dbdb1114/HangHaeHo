import http from 'k6/http';
import { check } from 'k6';

export const options = {
    stages: [
        { duration: '10s', target: 300 },  // 10Ï¥à ÎèôÏïà 300Î™ÖÍπåÏßÄ Ï¶ùÍ∞Ä
        { duration: '10s', target: 700 },  // 10Ï¥à ÎèôÏïà 700Î™ÖÍπåÏßÄ Ï¶ùÍ∞Ä
        { duration: '10s', target: 1000 }, // 10Ï¥à ÎèôÏïà 1000Î™ÖÍπåÏßÄ Ï¶ùÍ∞Ä
    ],
};

// üéüÔ∏è Ìã∞Ïºì Ï†ïÎ≥¥
let showingIdx = 0;
let ticketIdx = 0;

const ticketList = [
    {"showingId" : 9501,"ticketList" : [58575,58574,58573,58572,58571,58570,58569,58568,58567,58566,58565,58564,58563,58562,58561,58560,58559,58558,58557,58556,58555,58554,58553,58552,58551]},
    {"showingId" : 9502,"ticketList" : [58600,58599,58598,58597,58596,58595,58594,58593,58592,58591,58590,58589,58588,58587,58586,58585,58584,58583,58582,58581,58580,58579,58578,58577,58576]},
    {"showingId" : 9503,"ticketList" : [58625,58624,58623,58622,58621,58620,58619,58618,58617,58616,58615,58614,58613,58612,58611,58610,58609,58608,58607,58606,58605,58604,58603,58602,58601]},
    {"showingId" : 9504,"ticketList" : [58650, 58649, 58648, 58647, 58646, 58645, 58644, 58643, 58642, 58641, 58640, 58639, 58638, 58637, 58636, 58635, 58634, 58633, 58632, 58631, 58630, 58629, 58628, 58627, 58626]},
    {"showingId" : 9505,"ticketList" : [58675, 58674, 58673, 58672, 58671, 58670, 58669, 58668, 58667, 58666, 58665, 58664, 58663, 58662, 58661, 58660, 58659, 58658, 58657, 58656, 58655, 58654, 58653, 58652, 58651]},
    {"showingId" : 9506,"ticketList" : [58700, 58699, 58698, 58697, 58696, 58695, 58694, 58693, 58692, 58691, 58690, 58689, 58688, 58687, 58686, 58685, 58684, 58683, 58682, 58681, 58680, 58679, 58678, 58677, 58676]},
    {"showingId" : 9507,"ticketList" : [58725, 58724, 58723, 58722, 58721, 58720, 58719, 58718, 58717, 58716, 58715, 58714, 58713, 58712, 58711, 58710, 58709, 58708, 58707, 58706, 58705, 58704, 58703, 58702, 58701]},
    {"showingId" : 9508,"ticketList" : [58750, 58749, 58748, 58747, 58746, 58745, 58744, 58743, 58742, 58741, 58740, 58739, 58738, 58737, 58736, 58735, 58734, 58733, 58732, 58731, 58730, 58729, 58728, 58727, 58726]},
    {"showingId" : 9509,"ticketList" : [58775, 58774, 58773, 58772, 58771, 58770, 58769, 58768, 58767, 58766, 58765, 58764, 58763, 58762, 58761, 58760, 58759, 58758, 58757, 58756, 58755, 58754, 58753, 58752, 58751]},
    {"showingId" : 9510,"ticketList" : [58800, 58799, 58798, 58797, 58796, 58795, 58794, 58793, 58792, 58791, 58790, 58789, 58788, 58787, 58786, 58785, 58784, 58783, 58782, 58781, 58780, 58779, 58778, 58777, 58776]},
    {"showingId" : 9511,"ticketList" : [58825, 58824, 58823, 58822, 58821, 58820, 58819, 58818, 58817, 58816, 58815, 58814, 58813, 58812, 58811, 58810, 58809, 58808, 58807, 58806, 58805, 58804, 58803, 58802, 58801]},
    {"showingId" : 9512,"ticketList" : [58850, 58849, 58848, 58847, 58846, 58845, 58844, 58843, 58842, 58841, 58840, 58839, 58838, 58837, 58836, 58835, 58834, 58833, 58832, 58831, 58830, 58829, 58828, 58827, 58826]},
    {"showingId" : 9513,"ticketList" : [58875, 58874, 58873, 58872, 58871, 58870, 58869, 58868, 58867, 58866, 58865, 58864, 58863, 58862, 58861, 58860, 58859, 58858, 58857, 58856, 58855, 58854, 58853, 58852, 58851]},
    {"showingId" : 9514,"ticketList" : [58900, 58899, 58898, 58897, 58896, 58895, 58894, 58893, 58892, 58891, 58890, 58889, 58888, 58887, 58886, 58885, 58884, 58883, 58882, 58881, 58880, 58879, 58878, 58877, 58876]}
]
// üöÄ Ìã∞Ïºì ÏöîÏ≤≠ Í∞ùÏ≤¥ ÏÉùÏÑ± Ìï®Ïàò
function getNextReqObj(username) {
    // ‚ùó Í∞Å VUÎßàÎã§ Í≥†Ïú†Ìïú showingIdxÏôÄ ticketIdxÎ•º ÏÉùÏÑ±
    const showingIdx = (__VU - 1) % ticketList.length; // VU IDÎ•º Í∏∞Î∞òÏúºÎ°ú Í≥†Ïú†Ìïú `showingIdx` ÏÑ§Ï†ï
    const ticketOffset = ((__VU - 1) * 5) % 25; // VU IDÎ•º Í∏∞Î∞òÏúºÎ°ú Í≥†Ïú†Ìïú `ticketIdx` ÏÑ§Ï†ï

    const nowReqObj = {
        "showingId": ticketList[showingIdx].showingId,
        "ticketList": [],
        "username": username,
    };

    // 5Í∞úÏùò Ìã∞ÏºìÏùÑ ÏÑ†ÌÉù
    for (let i = 0; i < 5; i++) {
        nowReqObj.ticketList.push({ "ticketId": ticketList[showingIdx].ticketList[ticketOffset + i] });
    }

    return nowReqObj;
}

// K6ÏóêÏÑú Ïã§ÌñâÎê† Ìï®Ïàò (1000Î™ÖÏùò ÏÇ¨Ïö©Ïûê)
export default function () {
    const username = `vuser${__VU}`;
    const payload = JSON.stringify(getNextReqObj(username));

    const params = {
        headers: {
            'Content-Type': 'application/json',
        },
    };

    const url = 'http://localhost:8080/api/v1/ticket/reservation'; // Ïã§Ï†ú API ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏÑ§Ï†ï

    const res = http.post(url, payload, params);

    // ‚úÖ 200 OK ÎòêÎäî 400 BAD_REQUESTÎèÑ Ï†ïÏÉÅ ÏöîÏ≤≠ÏúºÎ°ú ÌåêÎã®
    check(res, {
        'is status 200 or 400': (r) => r.status === 200 || r.status === 400,
    });

    console.log(`VU ${__VU} ÏöîÏ≤≠: ${payload}`); // Î°úÍ∑∏ Ï∂úÎ†• (ÌÖåÏä§Ìä∏ ÌôïÏù∏Ïö©)
}
